# @isdk/tool-rpc

`@isdk/tool-rpc` æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ TypeScript åº“ï¼Œå®ƒå°† `@isdk/tool-func` çš„æ¨¡å—åŒ–èƒ½åŠ›ä»æœ¬åœ°æ‰©å±•åˆ°ç½‘ç»œã€‚é€šè¿‡å®ƒï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°å°† `ToolFunc` ä½œä¸ºè¿œç¨‹æœåŠ¡æš´éœ²ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·æ— ç¼è°ƒç”¨ã€‚å®ƒéå¸¸é€‚åˆç”¨äºæ„å»ºåˆ†å¸ƒå¼ AI ä»£ç†ã€å¾®æœåŠ¡æ¶æ„æˆ–ä»»ä½•éœ€è¦åœ¨ä¸åŒè¿›ç¨‹æˆ–æœºå™¨ä¹‹é—´è¿›è¡Œå·¥å…·è°ƒç”¨çš„åœºæ™¯ã€‚

æœ¬é¡¹ç›®åŸºäº `@isdk/tool-func` æ„å»ºã€‚åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç†Ÿæ‚‰å…¶æ ¸å¿ƒæ¦‚å¿µã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

- **åˆ†å±‚æŠ½è±¡:** æä¾›äº†ä¸€å¥—åˆ†å±‚çš„å·¥å…·ç±» (`ServerTools`, `RpcMethodsServerTool`, `ResServerTools`)ï¼Œå…è®¸æ‚¨æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æŠ½è±¡çº§åˆ«ã€‚
- **ğŸŒ RESTful æ¥å£:** ä½¿ç”¨ `ResServerTools` å¿«é€Ÿåˆ›å»ºç¬¦åˆ REST é£æ ¼çš„ APIï¼Œè‡ªåŠ¨å¤„ç† `get`, `list`, `post`, `put`, `delete` ç­‰æ ‡å‡†æ“ä½œã€‚
- **ğŸ”§ RPC æ–¹æ³•åˆ†ç»„:** ä½¿ç”¨ `RpcMethodsServerTool` å°†å¤šä¸ªç›¸å…³å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰æ†ç»‘åœ¨å•ä¸ªå·¥å…·ä¸‹ï¼Œé€šè¿‡ `act` å‚æ•°è¿›è¡Œè°ƒç”¨ã€‚
- **ğŸ”Œ å®¢æˆ·ç«¯è‡ªåŠ¨ä»£ç†:** å®¢æˆ·ç«¯ (`ClientTools` åŠå…¶å­ç±») èƒ½ä»æœåŠ¡å™¨è‡ªåŠ¨åŠ è½½å·¥å…·å®šä¹‰ï¼Œå¹¶åŠ¨æ€ç”Ÿæˆç±»å‹å®‰å…¨çš„ä»£ç†å‡½æ•°ï¼Œä½¿è¿œç¨‹è°ƒç”¨å¦‚æœ¬åœ°è°ƒç”¨èˆ¬ç®€å•ã€‚
- **ğŸš€ å†…ç½® HTTP ä¼ è¾“:** æä¾›åŸºäº Node.js `http` æ¨¡å—çš„ `HttpServerToolTransport` å’ŒåŸºäº `fetch` çš„ `HttpClientToolTransport`ï¼Œå¼€ç®±å³ç”¨ã€‚
- **ğŸŒŠ æ”¯æŒæµå¼å“åº”:** æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å‡æ”¯æŒ `ReadableStream`ï¼Œå¯è½»æ¾å®ç°æµå¼æ•°æ®ä¼ è¾“ã€‚

## ğŸ“¦ å®‰è£…

```bash
npm install @isdk/tool-rpc @isdk/tool-func
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åˆ›å»ºä¸€ä¸ª RESTful å·¥å…·ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæš´éœ²å®ƒï¼Œå¹¶ä»å®¢æˆ·ç«¯è°ƒç”¨å®ƒã€‚

### ç¬¬ 1 æ­¥ï¼šå®šä¹‰æœåŠ¡å™¨ç«¯å·¥å…·

åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª `ResServerTools` çš„ç±»ã€‚å®ç° `get`, `list` ç­‰æ ‡å‡†æ–¹æ³•ï¼Œä»¥åŠä»»ä½•ä»¥ `$` ä¸ºå‰ç¼€çš„è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘æ–¹æ³•ã€‚

```typescript
// ./tools/UserTool.ts
import { ResServerTools, ResServerFuncParams } from '@isdk/tool-rpc';
import { NotFoundError } from '@isdk/common-error';

// ç”¨äºæ¼”ç¤ºçš„å†…å­˜æ•°æ®åº“
const users: Record<string, any> = {
  '1': { id: '1', name: 'çˆ±ä¸½ä¸' },
  '2': { id: '2', name: 'é²å‹ƒ' },
};

export class UserTool extends ResServerTools {
  // æ ‡å‡† RESTful æ–¹æ³•ï¼šGET /api/users/:id
  get({ id }: ResServerFuncParams) {
    const user = users[id as string];
    if (!user) throw new NotFoundError(id as string, 'user');
    return user;
  }

  // æ ‡å‡† RESTful æ–¹æ³•ï¼šGET /api/users
  list() {
    return Object.values(users);
  }

  // è‡ªå®šä¹‰ RPC æ–¹æ³•
  $promote({ id }: ResServerFuncParams) {
    const user = users[id as string];
    if (!user) throw new NotFoundError(id as string, 'user');
    return { ...user, role: 'admin' };
  }
}
```

### ç¬¬ 2 æ­¥ï¼šè®¾ç½®å¹¶å¯åŠ¨æœåŠ¡å™¨

åœ¨æ‚¨çš„æœåŠ¡å™¨å…¥å£æ–‡ä»¶ä¸­ï¼Œå®ä¾‹åŒ–å·¥å…·ï¼Œç„¶åè®¾ç½®å¹¶å¯åŠ¨ `HttpServerToolTransport`ã€‚

```typescript
// ./server.ts
import { HttpServerToolTransport, ResServerTools } from '@isdk/tool-rpc';
import { UserTool } from './tools/UserTool';

async function startServer() {
  // 1. å®ä¾‹åŒ–å¹¶æ³¨å†Œæ‚¨çš„å·¥å…·ã€‚
  // åç§° 'users' å°†ä½œä¸º URL çš„ä¸€éƒ¨åˆ† (ä¾‹å¦‚ /api/users)
  new UserTool('users').register();

  // 2. åˆå§‹åŒ–æœåŠ¡å™¨ä¼ è¾“å±‚
  const serverTransport = new HttpServerToolTransport();

  // 3. æŒ‚è½½å·¥å…·çš„åŸºç±»ã€‚ä¼ è¾“å±‚å°†æ‰¾åˆ°æ‰€æœ‰å·²æ³¨å†Œçš„ ResServerTools å®ä¾‹ã€‚
  // è¿™å°†åœ¨ '/api' å‰ç¼€ä¸‹åˆ›å»º API ç«¯ç‚¹ã€‚
  serverTransport.mount(ResServerTools, '/api');

  // 4. å¯åŠ¨æœåŠ¡å™¨
  const port = 3000;
  await serverTransport.start({ port });
  console.log(`âœ… å·¥å…·æœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬åœ°å€: http://localhost:${port}`);
}

startServer();
```

### ç¬¬ 3 æ­¥ï¼šè®¾ç½®å¹¶ä½¿ç”¨å®¢æˆ·ç«¯

åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ï¼Œåˆå§‹åŒ– `HttpClientToolTransport`ï¼Œå®ƒä¼šè‡ªåŠ¨ä»æœåŠ¡å™¨åŠ è½½å·¥å…·å®šä¹‰å¹¶åˆ›å»ºä»£ç†ã€‚

```typescript
// ./client.ts
import { HttpClientToolTransport, ResClientTools } from '@isdk/tool-rpc';

// å®šä¹‰ä¸€ä¸ªç±»å‹ä»¥è·å¾—å®Œæ•´çš„ç±»å‹æç¤ºï¼ŒåŒ…æ‹¬è‡ªå®šä¹‰æ–¹æ³•
type UserClientTool = ResClientTools & {
  promote(params: { id: string }): Promise<{ id: string; name: string; role: string }>;
};

async function main() {
  const apiRoot = 'http://localhost:3000/api';

  // 1. åˆå§‹åŒ–å®¢æˆ·ç«¯ä¼ è¾“å±‚
  const clientTransport = new HttpClientToolTransport(apiRoot);

  // 2. æŒ‚è½½å®¢æˆ·ç«¯å·¥å…·ã€‚æ­¤æ“ä½œå°†ï¼š
  //    a. ä¸º ResClientTools è®¾ç½®ä¼ è¾“å±‚
  //    b. ä»æœåŠ¡å™¨åŠ è½½ API å®šä¹‰å¹¶åˆ›å»ºä»£ç†å·¥å…·
  await clientTransport.mount(ResClientTools);

  // 3. è·å–ä¸ºè¿œç¨‹å·¥å…·åŠ¨æ€åˆ›å»ºçš„ä»£ç†
  const userTool = ResClientTools.get('users') as UserClientTool;
  if (!userTool) {
    throw new Error('è¿œç¨‹å·¥å…· "users" æœªæ‰¾åˆ°ï¼');
  }

  // 4. åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹ APIï¼

  // è°ƒç”¨ GET /api/users/1
  const user = await userTool.get!({ id: '1' });
  console.log('è·å–ç”¨æˆ·:', user); // { id: '1', name: 'çˆ±ä¸½ä¸' }

  // è°ƒç”¨ GET /api/users
  const allUsers = await userTool.list!();
  console.log('æ‰€æœ‰ç”¨æˆ·:', allUsers); // [{...}, {...}]

  // è°ƒç”¨è‡ªå®šä¹‰ RPC æ–¹æ³• $promote
  // å®¢æˆ·ç«¯ä»£ç†ä¼šè‡ªåŠ¨å¤„ç† `act` å‚æ•°
  const admin = await userTool.promote({ id: '2' });
  console.log('æå‡åçš„ç”¨æˆ·:', admin); // { id: '2', name: 'é²å‹ƒ', role: 'admin' }
}

main();
```

## æ ¸å¿ƒæ¦‚å¿µï¼šåˆ†å±‚æŠ½è±¡

`@isdk/tool-rpc` çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯åˆ†å±‚æŠ½è±¡ï¼Œå°†ç½‘ç»œé€šä¿¡ä¸ä¸šåŠ¡é€»è¾‘æ¸…æ™°åˆ†ç¦»ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€æ±‚çš„å¤æ‚åº¦é€‰æ‹©åˆé€‚çš„æŠ½è±¡å±‚çº§ã€‚

```mermaid
graph TD
    subgraph å®¢æˆ·ç«¯
        A[å®¢æˆ·ç«¯åº”ç”¨] --> B{ResClientTools};
        B --> C{RpcMethodsClientTool};
        C --> D{ClientTools};
    end
    subgraph ä¼ è¾“å±‚
        D --> |ä½¿ç”¨| E[IClientToolTransport];
        E -- HTTP è¯·æ±‚ --> F[IServerToolTransport];
    end
    subgraph æœåŠ¡å™¨ç«¯
        F -->|è°ƒç”¨| G{ServerTools};
        H{ResServerTools} --> I{RpcMethodsServerTool};
        I --> G;
    end

    A -- åœ¨å®ä¾‹ä¸Šè°ƒç”¨æ–¹æ³• --> B;
    B -- é€æ˜åœ°è°ƒç”¨ --> E;
    F -- æ¥æ”¶è¯·æ±‚å¹¶æŸ¥æ‰¾ --> H;
    H -- æ‰§è¡Œä¸šåŠ¡é€»è¾‘ --> H;
    H -- é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿”å›ç»“æœ --> F;
    F -- å‘é€ HTTP å“åº” --> E;
    E -- å°†ç»“æœè¿”å›ç»™ --> B;
    B -- å°†ç»“æœè¿”å›ç»™ --> A;
```

### å‘½åè¯´æ˜ï¼š`ServerTools` (å¤æ•°) vs. å®ä¾‹ (å•æ•°)

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ç±»å `ServerTools`ã€`ClientTools` ç­‰æ˜¯å¤æ•°å½¢å¼ã€‚è¿™æ˜¯ä¸€ä¸ªåˆ»æ„çš„è®¾è®¡ï¼Œåæ˜ äº†å…¶åŒé‡è§’è‰²ï¼š

- **é™æ€ç±»ä½œä¸ºæ³¨å†Œè¡¨ (The Plural 'Tools')**: `ServerTools` çš„é™æ€éƒ¨åˆ†ï¼ˆä¾‹å¦‚ `ServerTools.register()`, `ServerTools.items`ï¼‰å……å½“æ‰€æœ‰è¿œç¨‹å·¥å…·çš„**å…¨å±€æ³¨å†Œè¡¨å’Œç®¡ç†å™¨**ã€‚å®ƒæŒæœ‰ä¸€ä¸ªå·¥å…·é›†åˆï¼Œå¹¶æä¾›ç®¡ç†è¿™äº›å·¥å…·çš„é™æ€æ–¹æ³•ã€‚è¿™å°±æ˜¯åç§°ä¸­â€œToolsâ€ï¼ˆå¤æ•°ï¼‰çš„ç”±æ¥ã€‚

- **å®ä¾‹ä½œä¸ºå•ä¸ªå·¥å…· (The Singular 'Tool')**: å½“æ‚¨åˆ›å»ºä¸€ä¸ªå®ä¾‹æ—¶ï¼ˆä¾‹å¦‚ `new ServerTools({ name: 'myTool', ... })`ï¼‰ï¼Œæ‚¨å®é™…ä¸Šæ˜¯åœ¨å®šä¹‰ä¸€ä¸ª**å•ä¸€çš„ã€å…·ä½“çš„å·¥å…·**ã€‚è¿™ä¸ªå®ä¾‹å°è£…äº†å•ä¸ªå‡½æ•°çš„é€»è¾‘ã€å…ƒæ•°æ®å’Œé…ç½®ã€‚

ç®€è€Œè¨€ä¹‹ï¼š**ç±»æ˜¯å·¥å…·çš„é›†åˆï¼Œå®ä¾‹æ˜¯å•ä¸ªå·¥å…·ã€‚** è¿™ç§è®¾è®¡å°†å·¥å…·çš„ç®¡ç†ï¼ˆé™æ€ï¼‰ä¸å·¥å…·çš„å®šä¹‰ï¼ˆå®ä¾‹ï¼‰æ¸…æ™°åœ°åˆ†ç¦»å¼€æ¥ã€‚

### ç¬¬ 1 å±‚ï¼š`ServerTools` / `ClientTools` - åŸºç¡€è¿œç¨‹å‡½æ•°

è¿™æ˜¯æœ€åŸºç¡€çš„å±‚ï¼Œä»£è¡¨ä¸€ä¸ªå•ä¸€çš„ã€å¯è¿œç¨‹è°ƒç”¨çš„å‡½æ•°ã€‚

- **`ServerTools`**:
  - **æ¦‚å¿µ**: ä¸€ä¸ªç‹¬ç«‹çš„ã€å¯è¢«è¿œç¨‹æ‰§è¡Œçš„å‡½æ•°ã€‚
  - **ç”¨é€”**: å½“æ‚¨åªéœ€è¦æš´éœ²ä¸€äº›é›¶æ•£ã€æ— å¤ªå¤šå…³è”çš„å‡½æ•°æ—¶ï¼Œè¿™æ˜¯æœ€ç®€å•çš„æ–¹å¼ã€‚
  - **é«˜çº§ç”¨æ³•**: åœ¨ `func` ä¸­ï¼Œå¯ä»¥é€šè¿‡ `params._req` å’Œ `params._res` è®¿é—®åŸå§‹çš„ HTTP è¯·æ±‚å’Œå“åº”å¯¹è±¡ï¼Œä»¥ä¾¿è¿›è¡Œæ›´åº•å±‚çš„æ§åˆ¶ã€‚
  - **ç¤ºä¾‹**:

    ```typescript
    // server.ts
    new ServerTools({
      name: 'ping',
      isApi: true, // æ ‡è®°ä¸ºå¯è¢«å‘ç°
      func: () => 'pong',
    }).register();
    ```

- **`ClientTools`**:
  - **æ¦‚å¿µ**: æœåŠ¡å™¨ä¸Š `ServerTools` çš„å®¢æˆ·ç«¯ä»£ç†ã€‚
  - **å·¥ä½œåŸç†**: `client.init()` åï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªåä¸º `ping` çš„ `ClientTools` å®ä¾‹ã€‚å½“æ‚¨è°ƒç”¨ `ToolFunc.run('ping')` æ—¶ï¼Œå®ƒä¼šé€šè¿‡ç½‘ç»œå°†è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ã€‚

### ç¬¬ 2 å±‚ï¼š`RpcMethodsServerTool` / `RpcMethodsClientTool` - é¢å‘å¯¹è±¡çš„æœåŠ¡

è¿™ä¸€å±‚å°†å¤šä¸ªç›¸å…³çš„å‡½æ•°ç»„ç»‡æˆä¸€ä¸ªç±»ä¼¼â€œå¯¹è±¡â€æˆ–â€œæœåŠ¡â€çš„é›†åˆã€‚

- **`RpcMethodsServerTool`**:
  - **æ¦‚å¿µ**: ä¸€ä¸ªåŒ…å«å¤šä¸ªå¯è°ƒç”¨æ–¹æ³•çš„â€œæœåŠ¡â€å¯¹è±¡ã€‚å®ƒå……å½“ä¸€ä¸ªåˆ†å‘å™¨ã€‚
  - **ç”¨é€”**: å½“æ‚¨æœ‰ä¸€ç»„åŠŸèƒ½å†…èšçš„æ“ä½œæ—¶ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª `UserService` åŒ…å« `createUser`, `updateUser`, `getUser`ï¼‰ï¼Œä½¿ç”¨æ­¤ç±»å¯ä»¥æ›´å¥½åœ°ç»„ç»‡ä»£ç ã€‚
  - **å·¥ä½œåŸç†**: åœ¨ç±»ä¸­ï¼Œä»¥ `$` ä¸ºå‰ç¼€å®šä¹‰çš„æ–¹æ³•ï¼ˆå¦‚ `$createUser`ï¼‰ä¼šè¢«è‡ªåŠ¨æ³¨å†Œä¸º RPC æ–¹æ³•ã€‚å®¢æˆ·ç«¯é€šè¿‡åœ¨è¯·æ±‚ä¸­ä¼ é€’ `act: '$createUser'` å‚æ•°æ¥æŒ‡å®šè°ƒç”¨å“ªä¸ªæ–¹æ³•ã€‚
  - **ç¤ºä¾‹**:

    ```typescript
    // server.ts
    class UserService extends RpcMethodsServerTool {
      $createUser({ name }) {
        // ... åˆ›å»ºç”¨æˆ·çš„é€»è¾‘
        return { id: 'user-1', name };
      }
      $getUser({ id }) {
        // ... è·å–ç”¨æˆ·çš„é€»è¾‘
        return { id, name: 'Test User' };
      }
    }
    new UserService('userService').register();
    ```

- **`RpcMethodsClientTool`**:
  - **æ¦‚å¿µ**: è¿œç¨‹æœåŠ¡å¯¹è±¡çš„å®¢æˆ·ç«¯ä»£ç†ã€‚
  - **å·¥ä½œåŸç†**: åˆå§‹åŒ–æ—¶ï¼Œå®ƒä¼šæ£€æµ‹åˆ°æœåŠ¡å™¨ä¸Šçš„ `$createUser` å’Œ `$getUser` æ–¹æ³•ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯å®ä¾‹ä¸ŠåŠ¨æ€åˆ›å»ºå¯¹åº”çš„ `createUser()` å’Œ `getUser()` æ–¹æ³•ã€‚è¿™ä½¿å¾—è°ƒç”¨çœ‹èµ·æ¥å°±åƒåœ¨è°ƒç”¨ä¸€ä¸ªæœ¬åœ°å¯¹è±¡çš„æ–¹æ³•ï¼Œå®Œå…¨éšè—äº†åº•å±‚çš„ `act` å‚æ•°å’Œç½‘ç»œé€šä¿¡ã€‚
  - **ç¤ºä¾‹**:

    ```typescript
    // client.ts
    const userService = RpcMethodsClientTool.get('userService');
    const newUser = await userService.createUser({ name: 'Alice' });
    ```

### ç¬¬ 3 å±‚ï¼š`ResServerTools` / `ResClientTools` - RESTful èµ„æº

è¿™æ˜¯æœ€é«˜çº§çš„æŠ½è±¡ï¼Œå®ƒåœ¨ RPC çš„åŸºç¡€ä¸Šæä¾›äº†ä¸€ä¸ªä»¥èµ„æºä¸ºä¸­å¿ƒçš„ RESTful é£æ ¼ APIã€‚

- **`ResServerTools`**:
  - **æ¦‚å¿µ**: ä»£è¡¨ä¸€ä¸ª RESTful èµ„æºï¼Œå†…ç½®äº†å¯¹æ ‡å‡† HTTP åŠ¨è¯ï¼ˆGET, POST, PUT, DELETEï¼‰çš„æ˜ å°„ã€‚
  - **ç”¨é€”**: ç”¨äºéœ€è¦æä¾›æ ‡å‡† CRUDï¼ˆåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼‰æ“ä½œçš„åœºæ™¯ï¼Œä¾‹å¦‚ç®¡ç† `users` æˆ– `products` èµ„æºã€‚
  - **å·¥ä½œåŸç†**: å®ƒç»§æ‰¿è‡ª `RpcMethodsServerTool`ï¼Œå¹¶é¢„å®šä¹‰äº† `get`, `list`, `post`, `put`, `delete` ç­‰ç‰¹æ®Šæ–¹æ³•ã€‚HTTP ä¼ è¾“å±‚ä¼šæ ¹æ®è¯·æ±‚çš„ `method` (GET/POST) å’Œ URL ä¸­æ˜¯å¦åŒ…å« `id` æ¥æ™ºèƒ½åœ°è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚
    - `GET /users/:id` -> `get({ id })`
    - `GET /users` -> `list()`
    - `POST /users` -> `post({ val })`
  - **é«˜çº§ç”¨æ³•**: ç”±äºå®ƒç»§æ‰¿è‡ª `RpcMethodsServerTool`ï¼Œæ‚¨ä»ç„¶å¯ä»¥åœ¨ `ResServerTools` çš„å­ç±»ä¸­å®šä¹‰è‡ªå®šä¹‰çš„ `$` æ–¹æ³•ï¼Œä»è€Œå°† RESTful é£æ ¼ä¸ç‰¹å®šçš„ RPC è°ƒç”¨ç»“åˆèµ·æ¥ï¼ˆå¦‚æ­¤é¡µçš„å¿«é€Ÿå…¥é—¨ç¤ºä¾‹æ‰€ç¤ºï¼‰ã€‚

- **`ResClientTools`**:
  - **æ¦‚å¿µ**: è¿œç¨‹ RESTful èµ„æºçš„å®¢æˆ·ç«¯ä»£ç†ã€‚
  - **å·¥ä½œåŸç†**: å®ƒæä¾›äº†ä¸€ç»„ä¾¿æ·çš„æ–¹æ³•ï¼Œå¦‚ `.get()`, `.list()`, `.post()` ç­‰ï¼Œè¿™äº›æ–¹æ³•ä¼šè‡ªåŠ¨æ„é€ å¹¶å‘é€ç¬¦åˆ REST è¯­ä¹‰çš„è¯·æ±‚ã€‚
  - **ç¤ºä¾‹**:

    ```typescript
    // client.ts
    const userRes = ResClientTools.get('users');
    const user = await userRes.get({ id: '1' }); // å‘é€ GET /api/users/1
    const allUsers = await userRes.list();       // å‘é€ GET /api/users
    ```

## ğŸ”Œ ä¼ è¾“å±‚ (Transport Layer)

ä¼ è¾“å±‚æ˜¯ `@isdk/tool-rpc` çš„æ ¸å¿ƒæ”¯æŸ±ï¼Œå®ƒå……å½“æœåŠ¡å™¨å·¥å…·å’Œå®¢æˆ·ç«¯å·¥å…·ä¹‹é—´çš„é€šä¿¡æ¡¥æ¢ï¼Œå®ç°äº†çœŸæ­£çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰ã€‚

### è®¾è®¡æ€æƒ³

ä¼ è¾“å±‚çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³æ˜¯**å…³æ³¨ç‚¹åˆ†ç¦»**ã€‚å®ƒå°†å·¥å…·çš„ä¸šåŠ¡é€»è¾‘ï¼ˆæ‚¨åœ¨ `Tool` ä¸­å®šä¹‰çš„ï¼‰ä¸ç½‘ç»œé€šä¿¡çš„å®ç°ç»†èŠ‚ï¼ˆå¦‚åè®®ã€è·¯ç”±ã€åºåˆ—åŒ–ï¼‰å®Œå…¨è§£è€¦ã€‚è¿™ä½¿å¾—æ‚¨çš„å·¥å…·ä»£ç ä¿æŒçº¯ç²¹å’Œå¯ç§»æ¤ï¼Œæ— éœ€å…³å¿ƒå®ƒæ˜¯é€šè¿‡ HTTPã€WebSockets è¿˜æ˜¯å…¶ä»–ä»»ä½•åè®®è¿›è¡Œé€šä¿¡ã€‚æ‚¨åªéœ€å®šä¹‰å·¥å…·çš„åŠŸèƒ½ï¼Œä¼ è¾“å±‚ä¼šå¤„ç†å¥½å‰©ä¸‹çš„äº‹æƒ…ã€‚

### æ ¸å¿ƒæŠ½è±¡

è¯¥æ¶æ„å›´ç»•å‡ ä¸ªå…³é”®æ¥å£æ„å»ºï¼š

- **`IToolTransport`**: æ‰€æœ‰ä¼ è¾“çš„é€šç”¨åŸºç¡€æ¥å£ï¼Œå®šä¹‰äº† `mount`ï¼ˆæŒ‚è½½ï¼‰ç­‰åŸºæœ¬æ“ä½œã€‚
- **`IServerToolTransport`**: æœåŠ¡å™¨ç«¯ä¼ è¾“å¿…é¡»å®ç°çš„æ¥å£ã€‚å…¶æ ¸å¿ƒèŒè´£æ˜¯ï¼š
    1. **æš´éœ²å‘ç°ç«¯ç‚¹**: åˆ›å»ºä¸€ä¸ªé€šå¸¸ä¸º `GET` çš„è·¯ç”±ï¼ˆä¾‹å¦‚ `/api`ï¼‰ï¼Œå½“å®¢æˆ·ç«¯è®¿é—®æ—¶ï¼Œå®ƒä¼šè¿”å›æ‰€æœ‰å·²æ³¨å†Œå¹¶å¯ç”¨çš„å·¥å…·çš„ JSON å®šä¹‰ã€‚è¿™æ˜¯é€šè¿‡ `addDiscoveryHandler` æ–¹æ³•å®ç°çš„ã€‚
    2. **å¤„ç† RPC è°ƒç”¨**: åˆ›å»ºä¸€ä¸ªé€šç”¨çš„ RPC è·¯ç”±ï¼ˆä¾‹å¦‚ `/api/:toolId`ï¼‰ï¼Œå®ƒæ¥æ”¶è¯·æ±‚ï¼Œæ ¹æ® `toolId` æŸ¥æ‰¾å¯¹åº”çš„å·¥å…·ï¼Œæ‰§è¡Œå®ƒï¼Œç„¶åè¿”å›ç»“æœã€‚è¿™æ˜¯é€šè¿‡ `addRpcHandler` æ–¹æ³•å®ç°çš„ã€‚
    3. ç®¡ç†æœåŠ¡å™¨ç”Ÿå‘½å‘¨æœŸ (`start`, `stop`)ã€‚
- **`IClientToolTransport`**: å®¢æˆ·ç«¯ä¼ è¾“å¿…é¡»å®ç°çš„æ¥å£ã€‚å…¶æ ¸å¿ƒèŒè´£æ˜¯ï¼š
    1. **åŠ è½½ API å®šä¹‰**: è°ƒç”¨ `loadApis()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè®¿é—®æœåŠ¡å™¨çš„å‘ç°ç«¯ç‚¹ä»¥è·å–æ‰€æœ‰å·¥å…·çš„å®šä¹‰ã€‚
    2. **æ‰§è¡Œè¿œç¨‹è°ƒç”¨**: å®ç° `fetch()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£å°†å®¢æˆ·ç«¯çš„å·¥å…·è°ƒç”¨ï¼ˆå‡½æ•°åå’Œå‚æ•°ï¼‰åºåˆ—åŒ–ï¼Œå‘é€åˆ°æœåŠ¡å™¨çš„ RPC ç«¯ç‚¹ï¼Œå¹¶å¤„ç†å“åº”ã€‚

### å†…ç½® HTTP ä¼ è¾“

æœ¬åº“æä¾›äº†ä¸€å¥—å³æ’å³ç”¨çš„ã€åŸºäº HTTP çš„ä¼ è¾“å®ç°ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼š

- **`HttpServerToolTransport`**: ä¸€ä¸ªæœåŠ¡å™¨ç«¯ä¼ è¾“ï¼Œä½¿ç”¨ Node.js å†…ç½®çš„ `http` æ¨¡å—æ¥åˆ›å»ºä¸€ä¸ªè½»é‡çº§çš„æœåŠ¡å™¨ã€‚å½“æ‚¨è°ƒç”¨ `serverTransport.mount(ServerTools, '/api')` æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ï¼š
  - åˆ›å»ºä¸€ä¸ª `GET /api` è·¯ç”±ç”¨äºæœåŠ¡å‘ç°ã€‚
  - åˆ›å»ºä¸€ä¸ª `POST /api/:toolId` è·¯ç”±ï¼ˆä¹Ÿæ”¯æŒå…¶ä»–æ–¹æ³•ï¼‰æ¥å¤„ç†æ‰€æœ‰å·¥å…·çš„ RPC è°ƒç”¨ã€‚å®ƒä¼šæ™ºèƒ½åœ°ä»è¯·æ±‚ä½“æˆ– URL å‚æ•°ä¸­è§£æå‡ºå·¥å…·çš„å‚æ•°ã€‚

- **`HttpClientToolTransport`**: ä¸€ä¸ªå®¢æˆ·ç«¯ä¼ è¾“ï¼Œä½¿ç”¨è·¨å¹³å°çš„ `fetch` API æ¥å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚å½“æ‚¨è°ƒç”¨ `client.init()`ï¼ˆå†…éƒ¨ä½¿ç”¨ `loadApis`ï¼‰æ—¶ï¼Œå®ƒä¼šè¯·æ±‚ `GET /api`ã€‚å½“æ‚¨è¿è¡Œä¸€ä¸ªå·¥å…·æ—¶ï¼Œå®ƒä¼šå‘ `POST /api/toolName` å‘é€ä¸€ä¸ªåŒ…å«å‚æ•°çš„ JSON è¯·æ±‚ã€‚

### åŠŸèƒ½æ‰©å±•ï¼šåˆ›å»ºæ‚¨è‡ªå·±çš„ä¼ è¾“

`@isdk/tool-rpc` çš„è®¾è®¡æ˜¯å®Œå…¨å¯æ‰©å±•çš„ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°ä¸Šè¿°æ¥å£æ¥åˆ›å»ºè‡ªå·±çš„ä¼ è¾“å±‚ï¼Œä»¥æ”¯æŒä¸åŒçš„åè®®ï¼ˆå¦‚ WebSockets, gRPCï¼‰æˆ–é›†æˆåˆ°ç°æœ‰çš„ Web æ¡†æ¶ï¼ˆå¦‚ Express, Koa, Fastifyï¼‰ä¸­ã€‚

**é›†æˆ Fastify æ¡†æ¶çš„æ€è·¯**ï¼š

1. åˆ›å»ºä¸€ä¸ª `FastifyServerTransport` ç±»å¹¶å®ç° `IServerToolTransport`ã€‚
2. åœ¨ `mount` æ–¹æ³•ä¸­ï¼Œæ‚¨ä¸å†åˆ›å»ºæ–°çš„ `http` æœåŠ¡å™¨ï¼Œè€Œæ˜¯æ¥æ”¶ä¸€ä¸ªç°æœ‰çš„ `FastifyInstance` ä½œä¸ºé€‰é¡¹ã€‚
3. ä½¿ç”¨ `fastify.get(apiPrefix, ...)` æ¥æ³¨å†Œå‘ç°è·¯ç”±ï¼Œå…¶å¤„ç†å™¨è°ƒç”¨ `ServerTools.toJSON()`ã€‚
4. ä½¿ç”¨ `fastify.all(apiPrefix + '/:toolId', ...)` æ¥æ³¨å†Œ RPC è·¯ç”±ï¼Œå…¶å¤„ç†å™¨ä» `request.body` æˆ– `request.query` ä¸­æå–å‚æ•°ï¼Œè°ƒç”¨ç›¸åº”çš„å·¥å…·ï¼Œç„¶åä½¿ç”¨ `reply` å‘é€å“åº”ã€‚
5. `start` å’Œ `stop` æ–¹æ³•å¯ä»¥å§”æ‰˜ç»™ Fastify å®ä¾‹çš„ `listen` å’Œ `close`ã€‚

è¿™ç§å¯æ’æ‹”çš„æ¶æ„ä¸º `@isdk/tool-rpc` æä¾›äº†æå¤§çš„çµæ´»æ€§ï¼Œä½¿å…¶èƒ½å¤Ÿè½»æ¾é€‚åº”å„ç§é¡¹ç›®éœ€æ±‚å’ŒæŠ€æœ¯æ ˆã€‚

## é«˜çº§ç”¨æ³•

æœ¬èŠ‚æ¶µç›–äº† `@isdk/tool-rpc` ä¸­ä¸€äº›æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ç”¨äºæ„å»ºçµæ´»é«˜æ•ˆçš„åº”ç”¨ç¨‹åºã€‚

### å¯¼å‡ºå‡½æ•°ä»¥åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†è®¡ç®—ä»æœåŠ¡å™¨å¸è½½æˆ–å…è®¸å®¢æˆ·ç«¯åœ¨æœ¬åœ°æ‰§è¡Œå‡½æ•°ã€‚`allowExportFunc` é€‰é¡¹é€šè¿‡åºåˆ—åŒ–å‡½æ•°ä½“å¹¶åœ¨å‘ç°é˜¶æ®µå°†å…¶å‘é€åˆ°å®¢æˆ·ç«¯æ¥å®ç°è¿™ä¸€ç‚¹ã€‚å½“è¯¥é€‰é¡¹è®¾ç½®ä¸º `true` æ—¶ï¼Œå®¢æˆ·ç«¯çš„ `ClientTools` å°†è‡ªåŠ¨ä½¿ç”¨è¿™ä¸ªä¸‹è½½çš„å‡½æ•°ï¼Œè€Œä¸æ˜¯å‘èµ·ç½‘ç»œè¯·æ±‚ã€‚

**æœåŠ¡å™¨ç«¯é…ç½®:**

```typescript
// server.ts
new ServerTools({
  name: 'local-uuid',
  isApi: true,
  allowExportFunc: true, // å…è®¸æ­¤å‡½æ•°è¢«ä¸‹è½½
  func: () => {
    // è¿™æ®µé€»è¾‘å°†åœ¨å®¢æˆ·ç«¯æ‰§è¡Œ
    console.log('æ­£åœ¨å®¢æˆ·ç«¯ç”Ÿæˆ UUID...');
    return Math.random().toString(36).substring(2, 15);
  },
}).register();
```

**å®¢æˆ·ç«¯ç”¨æ³•:**

```typescript
// client.ts
const uuidTool = ClientTools.get('local-uuid');
// æ­¤è°ƒç”¨å°†æ‰§è¡Œä¸‹è½½çš„å‡½æ•°ä½“ï¼Œä¸ä¼šå‘èµ·ç½‘ç»œè¯·æ±‚ã€‚
const uuid = await uuidTool.run();
console.log('ç”Ÿæˆçš„ UUID:', uuid);
```

### è‡ªåŠ¨ RESTful æ–¹æ³•è·¯ç”±

å½“ä½¿ç”¨ `ResServerTools` æ—¶ï¼Œæ¡†æ¶ä¼šæ™ºèƒ½åœ°è·¯ç”±ä¼ å…¥çš„ HTTP è¯·æ±‚ã€‚å®ƒä¼šæ£€æŸ¥ HTTP æ–¹æ³•å’Œ `id` å‚æ•°æ˜¯å¦å­˜åœ¨ï¼Œä»¥ç¡®å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚è¿™ä¸ªé€»è¾‘ç”±å·¥å…·å†…éƒ¨çš„ `getMethodFromParams` å¤„ç†ï¼Œæä¾›äº†ä»¥ä¸‹å¼€ç®±å³ç”¨çš„æ˜ å°„ï¼š

- `GET /api/my-resource` â†’ `list()`
- `GET /api/my-resource/123` â†’ `get({ id: '123' })`
- `POST /api/my-resource` â†’ `post({ val: ... })`

è¿™ä½¿æ‚¨èƒ½å¤Ÿç¼–å†™å¹²å‡€ã€é¢å‘èµ„æºçš„ä»£ç ï¼Œè€Œæ— éœ€æ‹…å¿ƒæ‰‹åŠ¨è·¯ç”±ã€‚

### æ··åˆ RESTful å’Œ RPC å·¥å…·

ç”±äº `ResServerTools` ç»§æ‰¿è‡ª `RpcMethodsServerTool`ï¼Œæ‚¨å¯ä»¥åœ¨å•ä¸ªå·¥å…·ä¸­ç»“åˆä¸¤ç§ API é£æ ¼ã€‚æ‚¨å¯ä»¥å®ç°æ ‡å‡†çš„ RESTful æ–¹æ³•ï¼ˆ`get`, `list`ï¼‰ï¼ŒåŒæ—¶æ·»åŠ è‡ªå®šä¹‰çš„ RPC é£æ ¼æ–¹æ³•ï¼ˆä¾‹å¦‚ `$archive`, `$publish`ï¼‰æ¥å¤„ç†ä¸ç¬¦åˆ CRUD æ¨¡å‹çš„ç‰¹å®šä¸šåŠ¡æ“ä½œã€‚

### è‡ªåŠ¨å‚æ•°ç±»å‹è½¬æ¢

æ‚¨åœ¨å·¥å…·ä¸Šå®šä¹‰çš„ `params` æ¨¡å¼ä¸ä»…ä»…ç”¨äºæ–‡æ¡£ã€‚æœåŠ¡å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨å®ƒæ¥å°†ä¼ å…¥çš„å‚æ•°è½¬æ¢ä¸ºå…¶æŒ‡å®šçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å®šä¹‰ `id: { type: 'number' }`ï¼Œä»»ä½•ä» URL è·¯å¾„ï¼ˆè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼‰æ¥æ”¶åˆ°çš„ `id` å°†åœ¨è°ƒç”¨æ‚¨çš„å‡½æ•°ä¹‹å‰è¢«è½¬æ¢ä¸º `Number`ã€‚

### å®¢æˆ·ç«¯æ–¹æ³•åˆ«å

ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå½“æ‚¨åœ¨æœåŠ¡å™¨ä¸Šç”¨ `$` å‰ç¼€å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ—¶ï¼ˆä¾‹å¦‚ `$promoteUser`ï¼‰ï¼Œå®¢æˆ·ç«¯ä»£ç†ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸å¸¦å‰ç¼€çš„æ›´æ¸…æ™°çš„åˆ«åã€‚è¿™å…è®¸æ‚¨åœ¨å®¢æˆ·ç«¯ä¸Šè°ƒç”¨ `myTool.promoteUser(...)`ï¼Œä½¿ä»£ç æ›´å…·å¯è¯»æ€§å’Œæƒ¯ç”¨æ€§ã€‚

## ğŸ¤ è´¡çŒ®

æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„è´¡çŒ®ï¼è¯·é˜…è¯» [CONTRIBUTING.md](./CONTRIBUTING.md) æ–‡ä»¶ä»¥è·å–æœ‰å…³å¦‚ä½•å¼€å§‹çš„æŒ‡å—ã€‚

## ğŸ“„ è®¸å¯è¯

è¯¥é¡¹ç›®æ ¹æ® MIT è®¸å¯è¯æˆæƒã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [LICENSE-MIT](./LICENSE-MIT) æ–‡ä»¶ã€‚
